<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Random Path Generator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="stylesheet" type="text/css" href="style.css">
    <style>
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .controls {
            flex: 1;
            min-width: 250px;
            max-width: 300px;
        }
        .visualization {
            flex: 3;
            min-width: 600px;
        }
        #gcodeOutput {
            width: 100%;
            min-height: 180px;
        }
        #chartContainer {
            width: 750px;
            height: 870px;
            transform: scale(0.75);
            transform-origin: 0 0;
            margin: 20px 0;
        }
        #pathChart {
            width: 100% !important;
            height: 100% !important;
            aspect-ratio: 750/870;
        }
        .form-group {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>CNC Random Path Generator</h1>
        
        <div class="main-content" style="display: flex; flex-wrap: wrap; gap: 15px;">
        <div class="controls">
            <!-- Generate button at the top -->
            <button id="generateBtn" style="margin-bottom: 15px;">Generate G-Code</button>
            
            <!-- Presets menu -->
            <div class="presets-menu">
                <h3>Presets</h3>
                <div class="form-group">
                    <label for="presetName">Preset Name:</label>
                    <input type="text" id="presetName" placeholder="My Config">
                </div>
                <button id="savePresetBtn">Save Current Settings</button>
                <button id="clearPresetsBtn">Clear All</button>
                <div class="preset-buttons" id="presetButtons"></div>
            </div>
            
            <!-- Input controls - more compact layout -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="form-group">
                    <label for="xMin">X Min (mm):</label>
                    <input type="number" id="xMin" value="50" min="0" max="750">
                </div>
                <div class="form-group">
                    <label for="xMax">X Max (mm):</label>
                    <input type="number" id="xMax" value="700" min="0" max="750">
                </div>
                <div class="form-group">
                    <label for="yMin">Y Min (mm):</label>
                    <input type="number" id="yMin" value="50" min="0" max="870">
                </div>
                <div class="form-group">
                    <label for="yMax">Y Max (mm):</label>
                    <input type="number" id="yMax" value="800" min="0" max="870">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div class="form-group">
                    <label for="xFeedRate">X Feed (mm/min):</label>
                    <input type="number" id="xFeedRate" value="13000">
                </div>
                <div class="form-group">
                    <label for="yFeedRate">Y Feed (mm/min):</label>
                    <input type="number" id="yFeedRate" value="13000">
                </div>
                <div class="form-group">
                    <label for="zFeedRate">Z Feed (mm/min):</label>
                    <input type="number" id="zFeedRate" value="2600">
                </div>
                <div class="form-group">
                    <label for="pointCount">Points:</label>
                    <input type="number" id="pointCount" value="20" min="1" max="1000">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px;">
                <div class="form-group">
                    <label for="zValue1">Z1 (mm):</label>
                    <input type="number" id="zValue1" value="137" min="0" max="207">
                </div>
                <div class="form-group">
                    <label for="zValue2">Z2 (mm):</label>
                    <input type="number" id="zValue2" value="127" min="0" max="207">
                </div>
                <div class="form-group">
                    <label for="zValue3">Z3 (mm):</label>
                    <input type="number" id="zValue3" value="117" min="0" max="207">
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 10px;">
                <label for="zTravelHeight">Z Travel (mm):</label>
                <input type="number" id="zTravelHeight" value="150" min="0" max="207">
            </div>
            
            <div class="workarea-info">
                <h3>Machine Limits:</h3>
                <p>X: 0-750mm, Y: 0-870mm, Z: 0-207mm</p>
            </div>
        </div>
        
        <div class="visualization">
            <h2>Tool Path Visualization (1:1.16 proportion, 750×870mm)</h2>
            <div id="chartContainer">
                <canvas id="pathChart"></canvas>
            </div>
            
            <h2>Generated G-Code</h2>
            <textarea id="gcodeOutput" readonly></textarea>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button id="copyBtn">Copy G-Code</button>
                <button id="downloadBtn">Download G-Code</button>
            </div>
        </div>
        </div>
    </div>

    <script>
        // Initialize chart
        const ctx = document.getElementById('pathChart').getContext('2d');
		
		const chartCanvas = document.getElementById('pathChart');
        chartCanvas.width = 750;  // X axis 750mm
        chartCanvas.height = 870; // Y axis 870mm
		
        let pathChart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Tool Path',
                    data: [],
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: { display: true, text: 'X Axis (mm)' },
                        min: 0,
                        max: 750,
                        ticks: { stepSize: 100 }
                    },
                    y: {
                        title: { display: true, text: 'Y Axis (mm)' },
                        min: 0,
                        max: 870,
                        ticks: { stepSize: 100 }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `X: ${context.parsed.x.toFixed(2)}mm, Y: ${context.parsed.y.toFixed(2)}mm`;
                            }
                        }
                    }
                }
            }
        });

        // Function to save current settings as a preset
        function savePreset() {
            const presetName = document.getElementById('presetName').value.trim();
            if (!presetName) {
                alert('Please enter a name for your preset');
                return;
            }
            
            const preset = {
                name: presetName,
                xMin: document.getElementById('xMin').value,
                xMax: document.getElementById('xMax').value,
                yMin: document.getElementById('yMin').value,
                yMax: document.getElementById('yMax').value,
                xFeedRate: document.getElementById('xFeedRate').value,
                yFeedRate: document.getElementById('yFeedRate').value,
                zFeedRate: document.getElementById('zFeedRate').value,
                pointCount: document.getElementById('pointCount').value,
                zValue1: document.getElementById('zValue1').value,
                zValue2: document.getElementById('zValue2').value,
                zValue3: document.getElementById('zValue3').value,
                zTravelHeight: document.getElementById('zTravelHeight').value
            };
            
            let presets = JSON.parse(localStorage.getItem('cncPresets') || '[]');
            presets = presets.filter(p => p.name !== presetName);
            presets.push(preset);
            localStorage.setItem('cncPresets', JSON.stringify(presets));
            
            updatePresetButtons();
            document.getElementById('presetName').value = '';
        }
        
        // Function to load a preset
        function loadPreset(preset) {
            document.getElementById('xMin').value = preset.xMin;
            document.getElementById('xMax').value = preset.xMax;
            document.getElementById('yMin').value = preset.yMin;
            document.getElementById('yMax').value = preset.yMax;
            document.getElementById('xFeedRate').value = preset.xFeedRate;
            document.getElementById('yFeedRate').value = preset.yFeedRate;
            document.getElementById('zFeedRate').value = preset.zFeedRate || 2600; // Default if not in preset
            document.getElementById('pointCount').value = preset.pointCount;
            document.getElementById('zValue1').value = preset.zValue1;
            document.getElementById('zValue2').value = preset.zValue2;
            document.getElementById('zValue3').value = preset.zValue3;
            document.getElementById('zTravelHeight').value = preset.zTravelHeight;
            
            generateGCode();
        }
        
        // Function to show all saved presets as buttons
        function updatePresetButtons() {
            const presets = JSON.parse(localStorage.getItem('cncPresets') || []);
            const container = document.getElementById('presetButtons');
            container.innerHTML = '';
            
            if (presets.length === 0) {
                container.innerHTML = '<p>No presets saved</p>';
                return;
            }
            
            presets.forEach(preset => {
                const btn = document.createElement('button');
                btn.className = 'preset-btn';
                btn.textContent = preset.name;
                btn.onclick = () => loadPreset(preset);
                container.appendChild(btn);
                
                const delBtn = document.createElement('button');
                delBtn.className = 'preset-btn';
                delBtn.textContent = '×';
                delBtn.style.backgroundColor = '#dc3545';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete preset "${preset.name}"?`)) {
                        const updated = presets.filter(p => p.name !== preset.name);
                        localStorage.setItem('cncPresets', JSON.stringify(updated));
                        updatePresetButtons();
                    }
                };
                container.appendChild(delBtn);
            });
        }
        
        // Function to clear all presets
        function clearPresets() {
            if (confirm('Delete ALL saved presets?')) {
                localStorage.removeItem('cncPresets');
                updatePresetButtons();
            }
        }
        
        // Function to copy G-code to clipboard
        function copyGCode() {
            const gcodeOutput = document.getElementById('gcodeOutput');
            gcodeOutput.select();
            document.execCommand('copy');
            alert('G-Code copied to clipboard!');
        }
        
        // Function to download G-code as file
        function downloadGCode() {
            const gcode = document.getElementById('gcodeOutput').value;
            if (!gcode.trim()) {
                alert('No G-Code to download. Generate G-Code first.');
                return;
            }
            
            const blob = new Blob([gcode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cnc_path.gcode';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Main function to generate G-code
        function generateGCode() {
            // Get all input values
            const xMin = parseFloat(document.getElementById('xMin').value) || 0;
            const xMax = parseFloat(document.getElementById('xMax').value) || 750;
            const yMin = parseFloat(document.getElementById('yMin').value) || 0;
            const yMax = parseFloat(document.getElementById('yMax').value) || 870;
            const xFeedRate = parseFloat(document.getElementById('xFeedRate').value) || 13000;
            const yFeedRate = parseFloat(document.getElementById('yFeedRate').value) || 13000;
            const zFeedRate = parseFloat(document.getElementById('zFeedRate').value) || 500;
            const pointCount = parseInt(document.getElementById('pointCount').value) || 20;
            const zValue1 = parseFloat(document.getElementById('zValue1').value) || 50;
            const zValue2 = parseFloat(document.getElementById('zValue2').value) || 100;
            const zValue3 = parseFloat(document.getElementById('zValue3').value) || 150;
            const zTravelHeight = parseFloat(document.getElementById('zTravelHeight').value) || 200;
            
            // Validate inputs
            if (xMin >= xMax || yMin >= yMax) {
                alert('Minimum values must be less than maximum values');
                return;
            }
            
            if (xMin < 0 || xMax > 750 || yMin < 0 || yMax > 870) {
                alert('X must be 0-750mm and Y must be 0-870mm');
                return;
            }
            
            // Generate random points
            const points = [];
            const zValues = [zValue1, zValue2, zValue3];
            
            for (let i = 0; i < pointCount; i++) {
                const x = Math.random() * (xMax - xMin) + xMin;
                const y = Math.random() * (yMax - yMin) + yMin;
                const z = zValues[Math.floor(Math.random() * zValues.length)];
                points.push({ x, y, z });
            }
            
            // Update chart
            pathChart.data.datasets[0].data = points.map(p => ({ x: p.x, y: p.y }));
            pathChart.update();
            
            // Generate G-Code
            let gcode = "; CNC Random Path G-Code\n";
            gcode += "; Generated by CNC Path Generator\n";
            gcode += `; X range: ${xMin} to ${xMax} mm\n`;
            gcode += `; Y range: ${yMin} to ${yMax} mm\n`;
            gcode += `; Z values: ${zValue1}, ${zValue2}, ${zValue3} mm\n`;
            gcode += `; Points: ${pointCount}\n\n`;
            
            gcode += "G28 ; Return to home position\n";
            gcode += "G21 ; Millimeter units\n";
            gcode += "G17 ; XY plane selection\n\n";
            
            // Start position
            gcode += `G0 X${xMin.toFixed(2)} Y${yMin.toFixed(2)} Z${zTravelHeight.toFixed(2)} ; Move to start position\n`;
            
            // Generate movements with Z feedrate
            points.forEach((point, index) => {
                gcode += `\n; Point ${index + 1}\n`;
                gcode += `G0 X${point.x.toFixed(2)} Y${point.y.toFixed(2)} F${yFeedRate} ; Move to point\n`;
                gcode += `G1 Z${point.z.toFixed(2)} F${zFeedRate} ; Move to Z depth\n`;
                gcode += `G0 Z${zTravelHeight.toFixed(2)} ; Retract\n`;
            });
            
            // Final movement
            gcode += "\n; Final movement\n";
            gcode += `G0 X10 Y850 Z200 ; Move to end position\n`;
            gcode += "M30 ; Program end\n";
            
            // Output G-Code
            document.getElementById('gcodeOutput').value = gcode;
        }
        
        // Set up button click events
        document.getElementById('generateBtn').addEventListener('click', () => {
            requireAuth(() => generateGCode());
        });
        document.getElementById('savePresetBtn').addEventListener('click', savePreset);
        document.getElementById('clearPresetsBtn').addEventListener('click', clearPresets);
        document.getElementById('copyBtn').addEventListener('click', () => {
            requireAuth(() => copyGCode());
        });
        document.getElementById('downloadBtn').addEventListener('click', () => {
            requireAuth(() => downloadGCode());
        });
        
        // Load any saved presets when page loads
        updatePresetButtons();
        // Don't generate initial G-code automatically - user must authenticate first
    </script>
    
    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="auth.js"></script>
</body>
</html>